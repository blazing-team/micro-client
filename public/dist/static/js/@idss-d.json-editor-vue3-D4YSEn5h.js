import"./vue-CtDVafEO.js";import{m as Te}from"./monaco-editor-B5RCHlt7.js";import{m as ze,c as je,e as De}from"./@element-plus.icons-vue-Bg3IdkJH.js";import{p as ee,f as fe}from"./jsonc-parser-I1AINVet.js";import{l as We}from"./lodash-BxgdZxW4.js";import{i as de,u as S,b as he,t as me,r as O}from"./@vue.reactivity-Bi9M0yVH.js";import{E as ye,a as ve,b as Le}from"./element-plus-8GMMjX5x.js";import{d as $e,e as _,f as He,n as L,j as qe,w as R,a as ge,o as $,b as Ke,k as Y,l as be,m as pe,c as we}from"./@vue.runtime-core-KVqrk7Le.js";import{n as Ue,a as Ge}from"./@vue.shared-Dggo55H6.js";function x(t){return typeof t=="object"&&t!==null&&!Array.isArray(t)}function J(t,o){return de(t)&&(t=S(t)),he(t)&&(t=me(t)),de(o)&&(o=S(o)),he(o)&&(o=me(o)),Number.isNaN(t)&&Number.isNaN(o)?!0:We(t,o)}function Qe(t){return JSON.parse(JSON.stringify(t))}function H(t){const o=[];return t.startsWith("**")&&(o.push("**"),t=t.slice(2),t.startsWith(".")&&(t=t.slice(1))),t.split(".").forEach(n=>{if(n==="**"){o.push("**");return}const d=/([^[\]]+)|\[(\d*|\*)\]/g;let f;for(;f=d.exec(n);)f[1]!==void 0?f[1].includes("**")?f[1].split("**").forEach((e,i)=>{i>0&&o.push("**"),e&&o.push(e)}):o.push(f[1]):f[2]===""||f[2]==="*"?o.push(null):f[2]&&o.push(Number(f[2]))}),o.map(n=>{if(typeof n=="string"&&n!=="**"){const d=Number(n);return isNaN(d)?n:d}return n})}function re(t,o){let c=0,n=0;for(;n<o.length&&c<t.length;){const d=o[n];if(d==="**"){if(n===o.length-1)return!0;const f=o[n+1];for(let r=c;r<=t.length;r++)if((r===t.length||f===null||f===t[r]||typeof f=="number"&&typeof t[r]=="number")&&re(t.slice(r),o.slice(n+1)))return!0;return!1}else if(d===null)if(typeof t[c]=="number")c++,n++;else return!1;else if(d===t[c])c++,n++;else return!1}return c===t.length&&n===o.length}function B(t,o,c=[]){const n=[];return re(c,o)&&n.push([...c]),t==null||typeof t!="object"||(Array.isArray(t)?t.forEach((d,f)=>{n.push(...B(d,o,[...c,f]))}):x(t)&&Object.keys(t).forEach(d=>{n.push(...B(t[d],o,[...c,d]))})),n}function te(t,o,c=0){if(t==null)return t;const n=o.filter(r=>r.includes("**"));let f=[...o.filter(r=>!r.includes("**"))];if(n.forEach(r=>{const e=B(t,r);f.push(...e)}),Array.isArray(t)){if(f.map(i=>i[c]).filter(i=>i===null||typeof i=="number").length===0)return[];const e=[];return t.forEach((i,u)=>{const a=f.filter(g=>{const m=g[c];return m===null||m===u}),y=te(i,a,c+1);y!==void 0&&(typeof y!="object"||Object.keys(y).length>0||Array.isArray(y))&&e.push(y)}),e}if(x(t)){const r={},e=new Set;return f.forEach(i=>{const u=i[c];typeof u=="string"&&e.add(u)}),e.forEach(i=>{const u=f.filter(a=>a[c]===i).map(a=>a.slice(c+1)).filter(a=>a.length>0);if(u.length===0)i in t&&(r[i]=t[i]);else if(i in t){const a=te(t[i],u,0);a!==void 0&&(typeof a!="object"||Object.keys(a).length>0||Array.isArray(a))&&(r[i]=a)}}),r}}function ne(t,o,c=0){if(t==null)return t;const n=o.filter(r=>r.includes("**"));let f=[...o.filter(r=>!r.includes("**"))];if(n.forEach(r=>{const e=B(t,r);f.push(...e)}),Array.isArray(t)){if(f.map(i=>i[c]).filter(i=>i===null||typeof i=="number").length===0)return Qe(t);const e=[];return t.forEach((i,u)=>{const a=f.filter(y=>{const g=y[c];return g===null||g===u});e.push(ne(i,a,c+1))}),e}if(x(t)){const r={};for(const e in t){const i=f.filter(u=>u[c]===e);if(i.length===0)r[e]=t[e];else{const u=i.map(a=>a.slice(c+1));if(u.some(a=>a.length===0))continue;r[e]=ne(t[e],u,0)}}return r}return t}function Z(t,o,c){if(!t||typeof t!="object")return t;const n=o.map(H);return c?ne(t,n,0):te(t,n,0)}function oe(t,o,c,n=[]){const d=r=>c.some(e=>e.includes("**")?re(r,e):e.length>=r.length&&r.every((i,u)=>e[u]===null||e[u]===i||e[u]===null&&typeof i=="number")),f=r=>c.some(e=>e.includes("**")?!0:e.length>r.length&&r.every((i,u)=>e[u]===null||e[u]===i||e[u]===null&&typeof i=="number"));if(t==null||typeof t!="object"){if(d(n))return o!==void 0?o:t;if(o!==void 0&&!J(t,o)){const e=n.join(".")||"<root>";return t}return o!==void 0?o:t}if(Array.isArray(t)){const r=t.slice();for(let e=0;e<r.length;e++){const i=[...n,e];if(f(i)||d(i)){const u=Array.isArray(o)?o[e]:void 0;r[e]=oe(r[e],u,c,i)}else if(Array.isArray(o)&&e<o.length&&!J(r[e],o[e])){const u=i.join(".")}}if(Array.isArray(o)&&o.length>t.length)for(let e=t.length;e<o.length;e++)r.push(o[e]);return r}if(x(t)){const r={...t};for(const e in t){const i=[...n,e];if(f(i)||d(i))r[e]=oe(t[e],o==null?void 0:o[e],c,i);else if(o&&e in o&&!J(t[e],o[e])){const u=i.join(".")}}if(x(o))for(const e in o)e in t||(r[e]=o[e]);return r}return t}function le(t,o,c,n=0,d=[]){const f=c.filter(u=>u.includes("**"));let e=[...c.filter(u=>!u.includes("**"))];if(f.forEach(u=>{const a=B(t,u);e.push(...a)}),e.filter(u=>u.length===n).length>0){if(t!=null&&o!==void 0&&!J(t,o)){const u=d.join(".")}return t}if(t==null||typeof t!="object")return o!==void 0?o:t;if(Array.isArray(t)){const u=t.slice();for(let a=0;a<u.length;a++){const y=e.filter(m=>{if(m.length<=n)return!1;const w=m[n];return w===null||w===a}),g=Array.isArray(o)?o[a]:void 0;y.length>0?u[a]=le(u[a],g,c,n+1,[...d,a]):g!==void 0&&(u[a]=g)}if(Array.isArray(o)&&o.length>t.length)for(let a=t.length;a<o.length;a++)e.filter(m=>{if(m.length<=n)return!1;const w=m[n];return w===null||w===a}).some(m=>m.length===n+1)||u.push(o[a]);return u}if(x(t)){const u={...t};for(const a in t){const y=e.filter(m=>m.length<=n?!1:m[n]===a),g=o==null?void 0:o[a];y.length>0?u[a]=le(t[a],g,c,n+1,[...d,a]):g!==void 0&&(u[a]=g)}if(x(o))for(const a in o)a in t||e.filter(m=>m.length<=n?!1:m[n]===a).some(m=>m.length===n+1)||(u[a]=o[a]);return u}return t}function Xe(t,o,c,n=!1){if(!t||typeof t!="object"||!o||typeof o!="object")return t;const d=c.map(H);return n?le(t,o,d):oe(t,o,d)}function C(t,o){if(!t||o.length===0)return[t].filter(Boolean);const[c,...n]=o;if(c==="**"){const f=[];if(n.length===0)return Ee(t,f),f;const r=(e,i)=>{const u=C(e,i);f.push(...u),e.children&&e.children.forEach(a=>{r(a,i)})};return r(t,n),f}if(c===null)return t.type==="array"&&t.children?t.children.flatMap(f=>C(f,n)):[];if(typeof c=="number"){const f=fe(t,[c]);return f?n.length===0?[f]:C(f,n):[]}const d=fe(t,[c]);return d?n.length===0?[d]:C(d,n):[]}function Ee(t,o){o.push(t),t.children&&t.children.forEach(c=>Ee(c,o))}function Ye(t,o,c={}){var n,d;const{includeComma:f=!0,splitKeyValue:r=!1}=c,e=ee(t);if(!e)return[];const i=[];for(const u of o){const a=H(u),y=C(e,a);y.length;for(const g of y){const m=g.parent;if((m==null?void 0:m.type)==="property"){const w=(n=m.children)==null?void 0:n[0],V=(d=m.children)==null?void 0:d[1];if(!w||!V)continue;if(r)i.push({type:"key",start:w.offset,end:w.offset+w.length}),i.push({type:"value",start:V.offset,end:V.offset+V.length});else{let N=m.offset+m.length;if(f){const P=t.slice(N).match(/^\s*,/);P&&(N+=P[0].length)}i.push({type:"property",start:m.offset,end:N})}}}}return i}function Ze(t,o,c){var n,d;JSON.parse(o)&&JSON.parse(t);const f=ee(t),r=ee(o);if(!f||!r)return!1;for(const e of c){const i=H(e),u=C(f,i),a=C(r,i);for(let y=0;y<u.length;y++){const g=(n=u[y])==null?void 0:n.value;if(g===void 0)continue;const m=(d=a[y])==null?void 0:d.value,w=g===void 0&&m===void 0,V=J(g,m);if(!w&&!V)return!0}}return!1}const et={key:0,class:"toolbar floating-toolbar"},ft=$e({__name:"JsonEditor",props:{modelValue:{default:()=>({})},readonly:{type:Boolean,default:!1},visiblePaths:{},visiblePathsExclude:{type:Boolean,default:!1},readonlyPaths:{},height:{default:300},theme:{default:"light"},placeholder:{default:"{}"},showFormatButton:{type:Boolean,default:!0},showFullscreenButton:{type:Boolean,default:!0},autoFormat:{type:Boolean,default:!0},elFormItem:{},fixedHeight:{type:Boolean},backgroundColor:{},strict:{type:Boolean},width:{}},emits:["update:modelValue","update:error","focus","blur","format","fullscreen"],setup(t,{expose:o,emit:c}){const n=t,d=c,f=_(()=>{var l;return n.elFormItem||((l=n.elFormItem)==null?void 0:l.proxy)}),r=O(null);let e=null,i=null,u=null;const a=O(!1),y=O(!0),g=O(""),m=O("vs");let w=null,V=null,N=null;const M=O(!1),P=O(!1);let T=!1,A=!1,I="";const z=_(()=>n.visiblePathsExclude??!1),q=_(()=>n.readonly||!1),K=_(()=>{var l;try{let s=typeof n.modelValue=="string"?JSON.parse(n.modelValue||n.placeholder):n.modelValue;return(l=n.visiblePaths)!=null&&l.length&&(s=Z(s,n.visiblePaths,z.value)),JSON.stringify(s,null,2)}catch{return n.placeholder}}),U=_(()=>n.theme==="dark"?"vs-dark":n.theme==="light"?"vs":document.documentElement.classList.contains("dark")||document.documentElement.getAttribute("data-theme")==="dark"?"vs-dark":"vs"),se=(l="error",s)=>{y.value=!1,g.value=s,f.value&&(f.value.validateState=l,f.value.validateMessage=s),d("update:error",s)},ie=()=>{var l,s;y.value=!0,g.value="",(s=(l=f.value)==null?void 0:l.clearValidate)==null||s.call(l),d("update:error","")};function ae(){m.value=U.value,e&&i&&i.editor.setTheme(m.value)}function j(){if(!e)return!1;const l=e.getValue();try{const s=JSON.parse(l);if(n.strict&&(typeof s!="object"||s===null))throw new Error("Must be a JSON object in strict mode.");return!0}catch(s){return se("error",(s==null?void 0:s.message)||"JSON format error"),!1}}function Ve(){e&&(F(K.value),ie())}async function Se(){var l;if(!e||!j())return;const s=e.getValue();if(y.value){const h=JSON.parse(s);if((l=n.visiblePaths)!=null&&l.length){const v=Xe(h,typeof n.modelValue=="string"?JSON.parse(n.modelValue):n.modelValue,n.visiblePaths,!z.value);d("update:modelValue",v)}else d("update:modelValue",h)}}function Ne(){d("focus")}function Me(){var l;d("blur"),j()&&((l=f.value)==null||l.validate(),Se())}function Pe(l){a.value&&l.key==="Escape"&&(l.stopPropagation(),l.preventDefault(),Q())}function D(){var l;if(!e||!i||!((l=n.readonlyPaths)!=null&&l.length)||q.value)return;const s=e.getModel();if(!s)return;const h=s.getValue(),p=Ye(h,n.readonlyPaths,{includeComma:!1}).map(E=>{const b=s.getPositionAt(E.start),k=s.getPositionAt(E.end);return{range:new i.Range(b.lineNumber,b.column,k.lineNumber,k.column),options:{inlineClassName:"json-readonly-highlight",stickiness:i.editor.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges,hoverMessage:{value:"只读字段不可编辑"},afterCursorSticky:"never"}}});u?u.set(p):u=e.createDecorationsCollection(p)}function F(l){if(!e||!i)return;const s=e.saveViewState(),h=e.getModel(),v=i.editor.createModel(l,"json");e.setModel(v),h&&h!==v&&h.dispose(),setTimeout(()=>{try{s&&e.restoreViewState(s),e.focus()}catch(p){p==null||p.message}ue()},0)}function ue(){if(!e||!e.getModel())return;I=e.getValue();const s=()=>{if(!r.value)return;r.value.querySelectorAll('[style*="1.67772e+07px"], [style*="e+07px"]').forEach(E=>{const b=E;b.style.width="100%",b.style.height="100%",b.style.maxWidth="100%",b.style.maxHeight="100%",b.style.transform="none"})};e.onDidChangeModelContent(()=>{if(D(),s(),!e||A){A=!1;return}try{if(Ze(K.value,e.getValue(),n.readonlyPaths||[])){A=!0,F(I),Le.warning("只读字段不可编辑");return}}catch(p){se("error",(p==null?void 0:p.message)||"JSON format error")}try{JSON.parse(e.getValue()),I=e.getValue(),ie()}catch{}}),e.onDidBlurEditorText(()=>{Me(),s()}),e.onDidFocusEditorText(()=>{Ne(),s()});const h=setInterval(()=>{s()},2e3),v=e.dispose;e.dispose=()=>{clearInterval(h),v.call(e)},D()}function ke(l){let s=l.parentElement;for(;s;){const h=getComputedStyle(s);if(h.display==="none"||h.visibility==="hidden"||h.opacity==="0"||s.hidden||s.classList.contains("el-tab-pane")&&s.style.display==="none"||s.classList.contains("el-collapse-item__content")&&s.style.display==="none"||s.classList.contains("el-drawer")&&s.style.display==="none")return!0;s=s.parentElement}return!1}function Oe(l){return new Promise(s=>{const h=()=>{const E=l.getBoundingClientRect();return E.width>0&&E.height>0&&getComputedStyle(l).display!=="none"&&!ke(l)?(s(),!0):!1};if(h())return;let v=null;const p=new MutationObserver(()=>{h()&&(p.disconnect(),v==null||v.disconnect(),s())});typeof IntersectionObserver<"u"&&(v=new IntersectionObserver(E=>{const b=E[0];b.isIntersecting&&b.boundingClientRect.width>0&&b.boundingClientRect.height>0&&(p.disconnect(),v==null||v.disconnect(),s())},{threshold:.1}),v.observe(l)),p.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style","class","hidden"]}),setTimeout(()=>{p.disconnect(),v==null||v.disconnect(),s()},1e4)})}async function W(){if(!r.value||!i)return;await L(),await Oe(r.value);const l=r.value;l.style.position="relative",l.style.overflow="hidden",l.style.width="100%",l.style.height="100%",await new Promise(p=>setTimeout(p,50));const s=l.getBoundingClientRect();if(s.width===0||s.height===0){setTimeout(W,100);return}const h=Math.max(s.width||300,200),v=Math.max(s.height||150,100);if(!(h>5e4||v>5e4))try{e&&(e.dispose(),e=null),e=i.editor.create(l,{value:K.value,language:"json",theme:U.value,readOnly:q.value,automaticLayout:!0,minimap:{enabled:!1},scrollBeyondLastLine:!1,wordWrap:"on",lineNumbers:"on",glyphMargin:!1,folding:!0,lineDecorationsWidth:10,lineNumbersMinChars:3,renderLineHighlight:"line",contextmenu:!0,selectOnLineNumbers:!0,roundedSelection:!1,cursorStyle:"line",cursorBlinking:"blink",fontSize:14,fontFamily:'"Monaco", "Menlo", "Ubuntu Mono", "Consolas", monospace'}),e.layout({width:Math.floor(h),height:Math.floor(v)}),M.value=!0,P.value=!1,T=!1,setTimeout(()=>{ue(),Ce()},100)}catch{M.value=!1}}function Ce(){if(!e||!r.value)return;const l=r.value,h=setInterval(()=>{if(!e)return;const E=e.getLayoutInfo();(E.width>5e4||E.height>5e4)&&(P.value=!0,G())},2e3),v=e.dispose;e.dispose=()=>{clearInterval(h),v.call(e)};let p=null;V=new ResizeObserver(E=>{p&&clearTimeout(p),p=window.setTimeout(()=>{if(!e||!M.value)return;const b=E[0];if(b&&b.contentRect){const k=Math.max(Math.floor(b.contentRect.width),200),X=Math.max(Math.floor(b.contentRect.height),100);if(k<5e4&&X<5e4&&k>0&&X>0)try{e.layout({width:k,height:X})}catch{}}},150)}),V.observe(l),N=new IntersectionObserver(E=>{const b=E[0];b.isIntersecting&&b.boundingClientRect.width>0&&b.boundingClientRect.height>0&&(P.value||!M.value?G():setTimeout(()=>{if(e)try{e.layout()}catch{}},100))},{threshold:.1}),N.observe(l)}async function G(){T||(T=!0,M.value=!1,e&&(e.dispose(),e=null),await L(),await new Promise(l=>setTimeout(l,100)),await W())}He(async()=>{i=Te,ae(),w=new MutationObserver(ae),w.observe(document.documentElement,{attributes:!0,attributeFilter:["class","data-theme"]}),r.value?await W():(await L(),r.value&&await W())}),qe(()=>{w==null||w.disconnect(),V==null||V.disconnect(),N==null||N.disconnect(),e==null||e.dispose(),u==null||u.clear(),M.value=!1,P.value=!1,T=!1}),R(()=>U.value,l=>{m.value=l,e&&i&&i.editor.setTheme(l)}),R(()=>q.value,l=>e==null?void 0:e.updateOptions({readOnly:l})),R(()=>n.readonlyPaths,()=>{D()},{deep:!0,immediate:!1}),R(()=>n.modelValue,l=>{var s;let h;try{h=typeof l=="string"?JSON.parse(l):l}catch{h={}}(s=n.visiblePaths)!=null&&s.length&&(h=Z(h,n.visiblePaths,z.value));const v=JSON.stringify(h,null,2);e&&e.getValue()!==v&&(A=!0,I=v,F(v)),L(()=>D())},{deep:!0}),R([()=>n.visiblePaths,()=>n.visiblePathsExclude],()=>{var l;if(!e)return;let s;try{s=typeof n.modelValue=="string"?JSON.parse(n.modelValue||"{}"):n.modelValue}catch{s={}}(l=n.visiblePaths)!=null&&l.length&&(s=Z(s,n.visiblePaths,z.value));const h=JSON.stringify(s,null,2);e.getValue()!==h&&(A=!0,I=h,F(h))},{deep:!0});function ce(){if(e)try{const l=JSON.stringify(JSON.parse(e.getValue()),null,2);F(l),d("format")}catch{}}function Q(){const l=r.value;if(l){if(a.value)l.style.position="",l.style.top="",l.style.left="",l.style.width="",l.style.height="",l.style.zIndex="",l.style.minWidth="",l.style.minHeight="",delete l.dataset.originalWidth,delete l.dataset.originalHeight;else{const s=l.getBoundingClientRect();l.dataset.originalWidth=s.width.toString(),l.dataset.originalHeight=s.height.toString(),l.style.position="fixed",l.style.top="0",l.style.left="0",l.style.width="100vw",l.style.height="100vh",l.style.zIndex="1000",l.style.minWidth="0",l.style.minHeight="0"}a.value=!a.value,d("fullscreen",a.value),setTimeout(()=>{try{e==null||e.layout()}catch{}},150)}}function xe(){e==null||e.focus()}function Fe(){r.value&&r.value.blur()}function Ae(){if(!e)return n.modelValue||{};try{const l=e.getValue();return JSON.parse(l)}catch{return e.getValue()}}function Ie(l){if(e)try{const s=typeof l=="string"?l:JSON.stringify(l,null,2);F(s)}catch{}}function _e(){return j()}function Re(){return j()?Promise.resolve(!0):Promise.reject(new Error(g.value))}async function Je(){P.value=!0,await G()}function Be(){return M.value&&!!e}return o({format:ce,focus:xe,blur:Fe,toggleFullscreen:Q,validate:_e,validateAsync:Re,getValue:Ae,setValue:Ie,reset:Ve,reinitialize:Je,isReady:Be}),(l,s)=>{var h;return $(),ge("div",{class:Ge(["json-editor",{fullscreen:a.value,"is-error":!y.value||((h=f.value)==null?void 0:h.validateState)==="error"}]),style:Ue({backgroundColor:n.backgroundColor||"var(--el-bg-color, #fff)",width:n.width||"100%",height:typeof n.height=="number"?`${n.height}px`:n.height||"300px"}),onKeydown:Pe},[Ke("div",{class:"editor",ref_key:"editorContainer",ref:r},null,512),n.showFormatButton||n.showFullscreenButton?($(),ge("div",et,[n.showFormatButton?($(),be(S(ve),{key:0,content:"格式化 JSON",placement:"top"},{default:pe(()=>[we(S(ye),{size:"small",icon:S(ze),onClick:ce,circle:""},null,8,["icon"])]),_:1})):Y("",!0),n.showFullscreenButton?($(),be(S(ve),{key:1,content:a.value?"退出全屏":"全屏编辑",placement:"top"},{default:pe(()=>[we(S(ye),{size:"small",icon:a.value?S(je):S(De),onClick:Q,circle:""},null,8,["icon"])]),_:1},8,["content"])):Y("",!0)])):Y("",!0)],38)}}});export{ft as _};
