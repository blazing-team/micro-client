import{M as x,a as T,m as v,e as b,f as w,h as H,j as O,k as _}from"./@tiptap.core-HsqG-hEX.js";import{r as y,t as R,f as M,a as B}from"./linkifyjs-DVrXeg1a.js";import{P as m,a as A}from"./prosemirror-state-DcLGimL2.js";const P="[\0-   ᠎ -\u2029 　]",I=new RegExp(P),U=new RegExp(`${P}$`),N=new RegExp(P,"g");function V(t){return t.length===1?t[0].isLink:t.length===3&&t[1].isLink?["()","[]"].includes(t[0].value+t[2].value):!1}function W(t){return new m({key:new A("autolink"),appendTransaction:(e,n,o)=>{const i=e.some(r=>r.docChanged)&&!n.doc.eq(o.doc),l=e.some(r=>r.getMeta("preventAutolink"));if(!i||l)return;const{tr:a}=o,f=b(n.doc,[...e]);if(w(f).forEach(({newRange:r})=>{const d=H(o.doc,r,p=>p.isTextblock);let u,c;if(d.length>1)u=d[0],c=o.doc.textBetween(u.pos,u.pos+u.node.nodeSize,void 0," ");else if(d.length){const p=o.doc.textBetween(r.from,r.to," "," ");if(!U.test(p))return;u=d[0],c=o.doc.textBetween(u.pos,r.to,void 0," ")}if(u&&c){const p=c.split(I).filter(Boolean);if(p.length<=0)return!1;const g=p[p.length-1],E=u.pos+c.lastIndexOf(g);if(!g)return!1;const L=R(g).map(s=>s.toObject(t.defaultProtocol));if(!V(L))return!1;L.filter(s=>s.isLink).map(s=>({...s,from:E+s.start+1,to:E+s.end+1})).filter(s=>o.schema.marks.code?!o.doc.rangeHasMark(s.from,s.to,o.schema.marks.code):!0).filter(s=>t.validate(s.value)).filter(s=>t.shouldAutoLink(s.value)).forEach(s=>{O(s.from,s.to,o.doc).some(C=>C.mark.type===t.type)||a.addMark(s.from,s.to,t.type.create({href:s.href}))})}}),!!a.steps.length)return a}})}function D(t){return new m({key:new A("handleClickLink"),props:{handleClick:(e,n,o)=>{var i,l;if(o.button!==0||!e.editable)return!1;let a=o.target;const f=[];for(;a.nodeName!=="DIV";)f.push(a),a=a.parentNode;if(!f.find(c=>c.nodeName==="A"))return!1;const k=_(e.state,t.type.name),r=o.target,d=(i=r==null?void 0:r.href)!==null&&i!==void 0?i:k.href,u=(l=r==null?void 0:r.target)!==null&&l!==void 0?l:k.target;return r&&d?(window.open(d,u),!0):!1}}})}function z(t){return new m({key:new A("handlePasteLink"),props:{handlePaste:(e,n,o)=>{const{state:i}=e,{selection:l}=i,{empty:a}=l;if(a)return!1;let f="";o.content.forEach(r=>{f+=r.textContent});const k=M(f,{defaultProtocol:t.defaultProtocol}).find(r=>r.isLink&&r.value===f);return!f||!k?!1:t.editor.commands.setMark(t.type,{href:k.href})}}})}function h(t,e){const n=["http","https","ftp","ftps","mailto","tel","callto","sms","cid","xmpp"];return e&&e.forEach(o=>{const i=typeof o=="string"?o:o.scheme;i&&n.push(i)}),!t||t.replace(N,"").match(new RegExp(`^(?:(?:${n.join("|")}):|[^a-z]|[a-z0-9+.-]+(?:[^a-z+.-:]|$))`,"i"))}const X=x.create({name:"link",priority:1e3,keepOnSplit:!1,exitable:!0,onCreate(){this.options.validate&&!this.options.shouldAutoLink&&(this.options.shouldAutoLink=this.options.validate),this.options.protocols.forEach(t=>{if(typeof t=="string"){y(t);return}y(t.scheme,t.optionalSlashes)})},onDestroy(){B()},inclusive(){return this.options.autolink},addOptions(){return{openOnClick:!0,linkOnPaste:!0,autolink:!0,protocols:[],defaultProtocol:"http",HTMLAttributes:{target:"_blank",rel:"noopener noreferrer nofollow",class:null},isAllowedUri:(t,e)=>!!h(t,e.protocols),validate:t=>!!t,shouldAutoLink:t=>!!t}},addAttributes(){return{href:{default:null,parseHTML(t){return t.getAttribute("href")}},target:{default:this.options.HTMLAttributes.target},rel:{default:this.options.HTMLAttributes.rel},class:{default:this.options.HTMLAttributes.class}}},parseHTML(){return[{tag:"a[href]",getAttrs:t=>{const e=t.getAttribute("href");return!e||!this.options.isAllowedUri(e,{defaultValidate:n=>!!h(n,this.options.protocols),protocols:this.options.protocols,defaultProtocol:this.options.defaultProtocol})?!1:null}}]},renderHTML({HTMLAttributes:t}){return this.options.isAllowedUri(t.href,{defaultValidate:e=>!!h(e,this.options.protocols),protocols:this.options.protocols,defaultProtocol:this.options.defaultProtocol})?["a",v(this.options.HTMLAttributes,t),0]:["a",v(this.options.HTMLAttributes,{...t,href:""}),0]},addCommands(){return{setLink:t=>({chain:e})=>{const{href:n}=t;return this.options.isAllowedUri(n,{defaultValidate:o=>!!h(o,this.options.protocols),protocols:this.options.protocols,defaultProtocol:this.options.defaultProtocol})?e().setMark(this.name,t).setMeta("preventAutolink",!0).run():!1},toggleLink:t=>({chain:e})=>{const{href:n}=t;return this.options.isAllowedUri(n,{defaultValidate:o=>!!h(o,this.options.protocols),protocols:this.options.protocols,defaultProtocol:this.options.defaultProtocol})?e().toggleMark(this.name,t,{extendEmptyMarkRange:!0}).setMeta("preventAutolink",!0).run():!1},unsetLink:()=>({chain:t})=>t().unsetMark(this.name,{extendEmptyMarkRange:!0}).setMeta("preventAutolink",!0).run()}},addPasteRules(){return[T({find:t=>{const e=[];if(t){const{protocols:n,defaultProtocol:o}=this.options,i=M(t).filter(l=>l.isLink&&this.options.isAllowedUri(l.value,{defaultValidate:a=>!!h(a,n),protocols:n,defaultProtocol:o}));i.length&&i.forEach(l=>e.push({text:l.value,data:{href:l.href},index:l.start}))}return e},type:this.type,getAttributes:t=>{var e;return{href:(e=t.data)===null||e===void 0?void 0:e.href}}})]},addProseMirrorPlugins(){const t=[],{protocols:e,defaultProtocol:n}=this.options;return this.options.autolink&&t.push(W({type:this.type,defaultProtocol:this.options.defaultProtocol,validate:o=>this.options.isAllowedUri(o,{defaultValidate:i=>!!h(i,e),protocols:e,defaultProtocol:n}),shouldAutoLink:this.options.shouldAutoLink})),this.options.openOnClick===!0&&t.push(D({type:this.type})),this.options.linkOnPaste&&t.push(z({editor:this.editor,defaultProtocol:this.options.defaultProtocol,type:this.type})),t}});export{X as L};
