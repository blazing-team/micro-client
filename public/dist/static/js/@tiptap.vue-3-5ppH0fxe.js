import"./vue-CtDVafEO.js";import{p as f,q as g}from"./@tiptap.core-HsqG-hEX.js";import{d,f as C,j as p,h as a,p as y,n as _,g as w,q as l}from"./@vue.runtime-core-KVqrk7Le.js";import{s as S,r as h,u as x,m,a as b,c as N}from"./@vue.reactivity-Bi9M0yVH.js";import{r as u}from"./@vue.runtime-dom-C_oXYm3W.js";function c(n){return N((e,r)=>({get(){return e(),n},set(t){n=t,requestAnimationFrame(()=>{requestAnimationFrame(()=>{r()})})}}))}class E extends f{constructor(e={}){return super(e),this.contentComponent=null,this.appContext=null,this.reactiveState=c(this.view.state),this.reactiveExtensionStorage=c(this.extensionStorage),this.on("beforeTransaction",({nextState:r})=>{this.reactiveState.value=r,this.reactiveExtensionStorage.value=this.extensionStorage}),m(this)}get state(){return this.reactiveState?this.reactiveState.value:this.view.state}get storage(){return this.reactiveExtensionStorage?this.reactiveExtensionStorage.value:super.storage}registerPlugin(e,r){const t=super.registerPlugin(e,r);return this.reactiveState&&(this.reactiveState.value=t),t}unregisterPlugin(e){const r=super.unregisterPlugin(e);return this.reactiveState&&r&&(this.reactiveState.value=r),r}}const M=d({name:"EditorContent",props:{editor:{default:null,type:Object}},setup(n){const e=h(),r=w();return y(()=>{const t=n.editor;t&&t.options.element&&e.value&&_(()=>{if(!e.value||!t.options.element.firstChild)return;const o=x(e.value);e.value.append(...t.options.element.childNodes),t.contentComponent=r.ctx._,r&&(t.appContext={...r.appContext,provides:r.provides}),t.setOptions({element:o}),t.createNodeViews()})}),p(()=>{const t=n.editor;t&&(t.contentComponent=null,t.appContext=null)}),{rootEl:e}},render(){return a("div",{ref:n=>{this.rootEl=n}})}}),U=d({name:"NodeViewWrapper",props:{as:{type:String,default:"div"}},inject:["onDragStart","decorationClasses"],render(){var n,e;return a(this.as,{class:this.decorationClasses,style:{whiteSpace:"normal"},"data-node-view-wrapper":"",onDragstart:this.onDragStart},(e=(n=this.$slots).default)===null||e===void 0?void 0:e.call(n))}}),L=(n={})=>{const e=S();return C(()=>{e.value=new E(n)}),p(()=>{var r,t,o;const s=(r=e.value)===null||r===void 0?void 0:r.options.element,i=s==null?void 0:s.cloneNode(!0);(t=s==null?void 0:s.parentNode)===null||t===void 0||t.replaceChild(i,s),(o=e.value)===null||o===void 0||o.destroy()}),e};class P{constructor(e,{props:r={},editor:t}){this.editor=t,this.component=m(e),this.el=document.createElement("div"),this.props=b(r),this.renderedComponent=this.renderComponent()}get element(){return this.renderedComponent.el}get ref(){var e,r,t,o;return!((r=(e=this.renderedComponent.vNode)===null||e===void 0?void 0:e.component)===null||r===void 0)&&r.exposed?this.renderedComponent.vNode.component.exposed:(o=(t=this.renderedComponent.vNode)===null||t===void 0?void 0:t.component)===null||o===void 0?void 0:o.proxy}renderComponent(){let e=a(this.component,this.props);return this.editor.appContext&&(e.appContext=this.editor.appContext),typeof document<"u"&&this.el&&u(e,this.el),{vNode:e,destroy:()=>{this.el&&u(null,this.el),this.el=null,e=null},el:this.el?this.el.firstElementChild:null}}updateProps(e={}){Object.entries(e).forEach(([r,t])=>{this.props[r]=t}),this.renderComponent()}destroy(){this.renderedComponent.destroy()}}const R={editor:{type:Object,required:!0},node:{type:Object,required:!0},decorations:{type:Object,required:!0},selected:{type:Boolean,required:!0},extension:{type:Object,required:!0},getPos:{type:Function,required:!0},updateAttributes:{type:Function,required:!0},deleteNode:{type:Function,required:!0},view:{type:Object,required:!0},innerDecorations:{type:Object,required:!0},HTMLAttributes:{type:Object,required:!0}};class q extends g{mount(){const e={editor:this.editor,node:this.node,decorations:this.decorations,innerDecorations:this.innerDecorations,view:this.view,selected:!1,extension:this.extension,HTMLAttributes:this.HTMLAttributes,getPos:()=>this.getPos(),updateAttributes:(o={})=>this.updateAttributes(o),deleteNode:()=>this.deleteNode()},r=this.onDragStart.bind(this);this.decorationClasses=h(this.getDecorationClasses());const t=d({extends:{...this.component},props:Object.keys(e),template:this.component.template,setup:o=>{var s,i;return l("onDragStart",r),l("decorationClasses",this.decorationClasses),(i=(s=this.component).setup)===null||i===void 0?void 0:i.call(s,o,{expose:()=>{}})},__scopeId:this.component.__scopeId,__cssModules:this.component.__cssModules,__name:this.component.__name,__file:this.component.__file});this.handleSelectionUpdate=this.handleSelectionUpdate.bind(this),this.editor.on("selectionUpdate",this.handleSelectionUpdate),this.renderer=new P(t,{editor:this.editor,props:e})}get dom(){if(!this.renderer.element||!this.renderer.element.hasAttribute("data-node-view-wrapper"))throw Error("Please use the NodeViewWrapper component for your node view.");return this.renderer.element}get contentDOM(){return this.node.isLeaf?null:this.dom.querySelector("[data-node-view-content]")}handleSelectionUpdate(){const{from:e,to:r}=this.editor.state.selection,t=this.getPos();if(typeof t=="number")if(e<=t&&r>=t+this.node.nodeSize){if(this.renderer.props.selected)return;this.selectNode()}else{if(!this.renderer.props.selected)return;this.deselectNode()}}update(e,r,t){const o=s=>{this.decorationClasses.value=this.getDecorationClasses(),this.renderer.updateProps(s)};if(typeof this.options.update=="function"){const s=this.node,i=this.decorations,v=this.innerDecorations;return this.node=e,this.decorations=r,this.innerDecorations=t,this.options.update({oldNode:s,oldDecorations:i,newNode:e,newDecorations:r,oldInnerDecorations:v,innerDecorations:t,updateProps:()=>o({node:e,decorations:r,innerDecorations:t})})}return e.type!==this.node.type?!1:(e===this.node&&this.decorations===r&&this.innerDecorations===t||(this.node=e,this.decorations=r,this.innerDecorations=t,o({node:e,decorations:r,innerDecorations:t})),!0)}selectNode(){this.renderer.updateProps({selected:!0}),this.renderer.element&&this.renderer.element.classList.add("ProseMirror-selectednode")}deselectNode(){this.renderer.updateProps({selected:!1}),this.renderer.element&&this.renderer.element.classList.remove("ProseMirror-selectednode")}getDecorationClasses(){return this.decorations.map(e=>e.type.attrs.class).flat().join(" ")}destroy(){this.renderer.destroy(),this.editor.off("selectionUpdate",this.handleSelectionUpdate)}}function F(n,e){return r=>{if(!r.editor.contentComponent)return{};const t=typeof n=="function"&&"__vccOpts"in n?n.__vccOpts:n;return new q(t,r,e)}}export{M as E,U as N,F as V,P as a,R as n,L as u};
